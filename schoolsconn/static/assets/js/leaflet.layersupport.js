L.MarkerClusterGroup.LayerSupport=L.MarkerClusterGroup.extend({options:{singleAddRemoveBufferDuration:0},initialize:function(e){L.MarkerClusterGroup.prototype.initialize.call(this,e),this._featureGroup=new _ByPassingFeatureGroup,this._featureGroup.addEventParent(this),this._nonPointGroup=new _ByPassingFeatureGroup,this._nonPointGroup.addEventParent(this),this._layers={},this._proxyLayerGroups={},this._proxyLayerGroupsNeedRemoving={},this._singleAddRemoveBuffer=[]},checkIn:function(e){var r=this._toArray(e);return this._checkInGetSeparated(r),this},checkOut:function(e){var r,o,i=this._toArray(e),t=this._separateSingleFromGroupLayers(i,{groups:[],singles:[]}),a=t.groups,s=t.singles;for(r=0;r<s.length;r++)o=s[r],delete this._layers[L.stamp(o)],delete o._mcgLayerSupportGroup;for(this._originalRemoveLayers(s),r=0;r<a.length;r++)o=a[r],this._dismissProxyLayerGroup(o);return this},addLayers:function(e){var r,o,i,t=this._toArray(e),a=this._checkInGetSeparated(t),s=a.groups;for(this._originalAddLayers(a.singles),r=0;r<s.length;r++)o=s[r],i=L.stamp(o),this._proxyLayerGroups[i]=o,delete this._proxyLayerGroupsNeedRemoving[i],this._map&&this._map._originalAddLayer(o)},addLayer:function(e){return this._bufferSingleAddRemove(e,"addLayers"),this},_originalAddLayer:L.MarkerClusterGroup.prototype.addLayer,_originalAddLayers:L.MarkerClusterGroup.prototype.addLayers,removeLayers:function(e){var r,o,i=this._toArray(e),t=this._separateSingleFromGroupLayers(i,{groups:[],singles:[]}),a=t.groups,s=t.singles,n=0;for(this._originalRemoveLayers(s);n<a.length;n++)r=a[n],o=L.stamp(r),delete this._proxyLayerGroups[o],this._map?this._map._originalRemoveLayer(r):this._proxyLayerGroupsNeedRemoving[o]=r;return this},removeLayer:function(e){return this._bufferSingleAddRemove(e,"removeLayers"),this},_originalRemoveLayer:L.MarkerClusterGroup.prototype.removeLayer,_originalRemoveLayers:L.MarkerClusterGroup.prototype.removeLayers,onAdd:function(e){e._originalAddLayer=e._originalAddLayer||e.addLayer,e._originalRemoveLayer=e._originalRemoveLayer||e.removeLayer,L.extend(e,_layerSwitchMap);var r,o,i,t=this._removePreAddedLayers(e);for(r in this._originalOnAdd.call(this,e),this._proxyLayerGroups)o=this._proxyLayerGroups[r],e._originalAddLayer(o);for(r in this._proxyLayerGroupsNeedRemoving)o=this._proxyLayerGroupsNeedRemoving[r],e._originalRemoveLayer(o),delete this._proxyLayerGroupsNeedRemoving[r];for(i=0;i<t.length;i++)e.addLayer(t[i])},_originalOnAdd:L.MarkerClusterGroup.prototype.onAdd,_bufferSingleAddRemove:function(e,r){var o,i=this.options.singleAddRemoveBufferDuration;0<i?(this._singleAddRemoveBuffer.push({type:r,layer:e}),this._singleAddRemoveBufferTimeout||(o=L.bind(this._processSingleAddRemoveBuffer,this),this._singleAddRemoveBufferTimeout=setTimeout(o,i))):this[r](e)},_processSingleAddRemoveBuffer:function(){for(var e,r,o=this._singleAddRemoveBuffer,i=0,t=[];i<o.length;i++)e=o[i],r||(r=e.type),e.type===r?t.push(e.layer):(this[r](t),r=e.type,t=[e.layer]);this[r](t),o.length=0,clearTimeout(this._singleAddRemoveBufferTimeout),this._singleAddRemoveBufferTimeout=null},_checkInGetSeparated:function(e){var r,o,i=this._separateSingleFromGroupLayers(e,{groups:[],singles:[]}),t=i.groups,a=i.singles;for(r=0;r<t.length;r++)o=t[r],this._recruitLayerGroupAsProxy(o);for(r=0;r<a.length;r++)o=a[r],this._removeFromOtherGroupsOrMap(o),(this._layers[L.stamp(o)]=o)._mcgLayerSupportGroup=this;return i},_separateSingleFromGroupLayers:function(e,r){for(var o,i=r.groups,t=r.singles,a=L.Util.isArray,s=0;s<e.length;s++)(o=e[s])instanceof L.LayerGroup?(i.push(o),this._separateSingleFromGroupLayers(o.getLayers(),r)):a(o)?this._separateSingleFromGroupLayers(o,r):t.push(o);return r},_recruitLayerGroupAsProxy:function(e){var r=e._proxyMcgLayerSupportGroup;if(r){if(r===this)return;r.checkOut(e)}else this._removeFromOwnMap(e);e._proxyMcgLayerSupportGroup=this,e._originalAddLayer=e._originalAddLayer||e.addLayer,e._originalRemoveLayer=e._originalRemoveLayer||e.removeLayer,e._originalOnAdd=e._originalOnAdd||e.onAdd,e._originalOnRemove=e._originalOnRemove||e.onRemove,L.extend(e,_proxyLayerGroup)},_dismissProxyLayerGroup:function(e){if(void 0!==e._proxyMcgLayerSupportGroup&&e._proxyMcgLayerSupportGroup===this){delete e._proxyMcgLayerSupportGroup,e.addLayer=e._originalAddLayer,e.removeLayer=e._originalRemoveLayer,e.onAdd=e._originalOnAdd,e.onRemove=e._originalOnRemove;var r=L.stamp(e);delete this._proxyLayerGroups[r],delete this._proxyLayerGroupsNeedRemoving[r],this._removeFromOwnMap(e)}},_removeFromOtherGroupsOrMap:function(e){var r=e._mcgLayerSupportGroup;if(r){if(r===this)return;r.checkOut(e)}else e.__parent?e.__parent._group.removeLayer(e):this._removeFromOwnMap(e)},_removeFromOwnMap:function(e){e._map&&e._map.removeLayer(e)},_removePreAddedLayers:function(e){var r,o=this._layers,i=[];for(var t in o)(r=o[t])._map&&(i.push(r),e._originalRemoveLayer(r));return i},_toArray:function(e){return L.Util.isArray(e)?e:[e]}});var _ByPassingFeatureGroup=L.FeatureGroup.extend({addLayer:function(e){if(this.hasLayer(e))return this;e.addEventParent(this);var r=L.stamp(e);return this._layers[r]=e,this._map&&this._map._originalAddLayer(e),this.fire("layeradd",{layer:e})},removeLayer:function(e){if(!this.hasLayer(e))return this;e in this._layers&&(e=this._layers[e]),e.removeEventParent(this);var r=L.stamp(e);return this._map&&this._layers[r]&&this._map._originalRemoveLayer(this._layers[r]),delete this._layers[r],this.fire("layerremove",{layer:e})},onAdd:function(e){this._map=e,this.eachLayer(e._originalAddLayer,e)},onRemove:function(e){this.eachLayer(e._originalRemoveLayer,e),this._map=null}}),_proxyLayerGroup={addLayer:function(e){var r=this.getLayerId(e);return this._layers[r]=e,this._map?this._proxyMcgLayerSupportGroup.addLayer(e):this._proxyMcgLayerSupportGroup.checkIn(e),this},removeLayer:function(e){var r=e in this._layers?e:this.getLayerId(e);return this._proxyMcgLayerSupportGroup.removeLayer(e),delete this._layers[r],this},onAdd:function(){this._proxyMcgLayerSupportGroup.addLayers(this.getLayers())},onRemove:function(){this._proxyMcgLayerSupportGroup.removeLayers(this.getLayers())}},_layerSwitchMap={addLayer:function(e){return e._mcgLayerSupportGroup?e._mcgLayerSupportGroup._originalAddLayer(e):this._originalAddLayer(e)},removeLayer:function(e){return e._mcgLayerSupportGroup?e._mcgLayerSupportGroup._originalRemoveLayer(e):this._originalRemoveLayer(e)}};L.markerClusterGroup.layerSupport=function(e){return new L.MarkerClusterGroup.LayerSupport(e)};